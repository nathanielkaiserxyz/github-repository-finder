<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GitHub Action Bot Finder</title>
  <style>
    body { font-family: sans-serif; background: #121212; color: #e0e0e0; padding: 1rem; }
    input, button { margin: 0.5rem 0; padding: 0.4rem; }
    .results { margin-top: 1rem; }
    .repo { margin-bottom: 2rem; padding: 1rem; border: 1px solid #444; border-radius: 8px; }
  </style>
</head>
<body>
  <h2>Misconfigured GitHub Action Bot Finder</h2>
  <label>From: <input type="date" id="fromDate"></label><br>
  <label>To: <input type="date" id="toDate"></label><br>
  <button onclick="startSearch()">Start Search</button>

  <div style="margin-top:1rem;">
    <button onclick="prevPage()">Prev</button>
    <button onclick="nextPage()">Next</button>
  </div>

  <div class="results" id="results"></div>

  <script>
    let repos = [];
    let currentPage = 0;
    let from, to;

    async function startSearch() {
      from = document.getElementById("fromDate").value;
      to = document.getElementById("toDate").value;
      currentPage = 0;
      document.getElementById("results").textContent = "Searching...";

      const query = `pushed:${from}..${to} stars:<20 forks:<5`;
      const url = `https://api.github.com/search/repositories?q=${encodeURIComponent(query)}&sort=updated&order=desc&per_page=10`;
      const repoResp = await fetch(url);
      const repoData = await repoResp.json();

      if (!repoData.items) {
        document.getElementById("results").textContent = "No data or API rate limit reached.";
        return;
      }
      repos = repoData.items;
      showPage();
    }

    async function showPage() {
      if (repos.length === 0) return;

      const repo = repos[currentPage];
      const resultsDiv = document.getElementById("results");
      resultsDiv.textContent = "Loading commits for " + repo.full_name + "...";

      const commitsUrl = `https://api.github.com/repos/${repo.owner.login}/${repo.name}/commits?per_page=30`;
      const commitsResp = await fetch(commitsUrl);
      const commits = await commitsResp.json();

      if (!Array.isArray(commits)) {
        resultsDiv.textContent = "Error loading commits (likely rate-limited).";
        return;
      }

      let maintainerCount = {};
      let totalCommits = 0;

      for (const commit of commits) {
        totalCommits++;
        const author = commit.author ? commit.author.login : (commit.commit.author.name || "unknown");
        maintainerCount[author] = (maintainerCount[author] || 0) + 1;
      }

      const sorted = Object.entries(maintainerCount).sort((a, b) => b[1] - a[1]);
      const top4 = sorted.slice(0, 4);

      resultsDiv.innerHTML = `
        <div class="repo">
          <h3><a href="${repo.html_url}" target="_blank">${repo.full_name}</a></h3>
          <p><b>Total sampled commits:</b> ${totalCommits}</p>
          <p><b>Top maintainers (including bots):</b></p>
          <ul>${top4.map(([user, count]) => `<li>${user}: ${count} commits</li>`).join("")}</ul>
        </div>
        <p>Repo ${currentPage + 1} of ${repos.length}</p>
      `;
    }

    function nextPage() {
      if (currentPage < repos.length - 1) {
        currentPage++;
        showPage();
      }
    }

    function prevPage() {
      if (currentPage > 0) {
        currentPage--;
        showPage();
      }
    }
  </script>
</body>
</html>